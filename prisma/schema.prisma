generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Consent {
  id              String   @id @default(cuid())
  phoneHash       String
  version         String
  consentTextHash String
  ip              String
  createdAt       DateTime @default(now())

  @@index([phoneHash])
  @@map("consents")
}

model Booking {
  id             String   @id @default(cuid())
  bookingNumber  String   @unique
  phoneHash      String
  sessionId      String
  patientNameEnc String
  phoneEnc       String
  conditionEnc   String
  notesEnc       String
  serviceName    String
  specialty      String
  partnerId      String
  partnerName    String
  branchAddress  String
  preferredDate  String
  preferredTime  String
  encKeyId       String
  status         String   @default("pending")
  isDeleted      Boolean  @default(false)
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  confirmedAt       DateTime?
  completedAt       DateTime?
  bookedByStaffId   String?
  bookedByStaffName String?

  @@index([phoneHash])
  @@index([partnerId])
  @@index([expiresAt])
  @@index([status])
  @@index([partnerId, createdAt])
  @@index([isDeleted, status])
  @@index([isDeleted, expiresAt])
  @@map("bookings")
}

model EncryptionKey {
  id          String   @id @default(cuid())
  phoneHash   String   @unique
  keyMaterial String
  createdAt   DateTime @default(now())
  isRevoked   Boolean  @default(false)

  @@map("encryption_keys")
}

model AuditLog {
  id        String   @id @default(cuid())
  actorType String
  actorId   String
  action    String
  bookingId String?
  metadata  String?
  ip        String
  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([bookingId])
  @@index([createdAt])
  @@index([createdAt, actorType])
  @@map("audit_logs")
}

model Staff {
  id           String   @id @default(cuid())
  name         String   @unique
  email        String?
  role         String   // "cs", "doctor", "admin"
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([role])
  @@map("staff")
}

model ConsentToken {
  id                String    @id @default(cuid())
  token             String    @unique
  phoneHash         String
  partnerId         String
  partnerName       String
  serviceName       String
  dataDescription   String
  staffId           String
  staffName         String
  status            String    @default("pending")
  patientIp         String?
  patientUserAgent  String?
  deviceFingerprint String?
  otpCode           String?
  otpSentAt         DateTime?
  otpVerifiedAt     DateTime?
  bookingId         String?
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  acceptedAt        DateTime?

  @@index([token])
  @@index([staffId])
  @@map("consent_tokens")
}

model DeletionRequest {
  id          String    @id @default(cuid())
  phoneHash   String
  status      String    @default("pending")
  requestedBy String
  requestedAt DateTime  @default(now())
  completedAt DateTime?

  @@index([phoneHash])
  @@map("deletion_requests")
}

model Partner {
  id           String   @id
  name         String
  type         String   @default("hospital")
  website      String   @default("")
  bookingEmail String   @default("")
  phone        String   @default("")
  city         String   @default("")
  district     String   @default("")
  address      String   @default("")
  specialties  String[] @default([])
  notes        String   @default("")
  passwordHash String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  branches PartnerBranch[]
  services PartnerService[]

  @@index([city])
  @@map("partners")
}

model PartnerService {
  id          String  @id @default(cuid())
  partnerId   String
  name        String
  specialty   String
  description String  @default("")
  priceRange  String  @default("")
  duration    String  @default("")
  isActive    Boolean @default(true)

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([specialty])
  @@map("partner_services")
}

model PartnerBranch {
  id        String  @id @default(cuid())
  partnerId String
  name      String  @default("")
  city      String
  district  String  @default("")
  address   String
  phone     String  @default("")
  isActive  Boolean @default(true)

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([city])
  @@map("partner_branches")
}

model ApiUsageLog {
  id               String   @id @default(cuid())
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCostUsd Float
  model            String   @default("gpt-4o")
  specialty        String
  sessionId        String
  durationMs       Int      @default(0)
  createdAt        DateTime @default(now())

  @@index([createdAt])
  @@index([specialty])
  @@index([createdAt, specialty])
  @@map("api_usage_logs")
}

model RateLimit {
  id          String   @id @default(cuid())
  key         String   @unique
  windowStart DateTime
  count       Int      @default(1)
  updatedAt   DateTime @updatedAt

  @@index([windowStart])
  @@map("rate_limits")
}
